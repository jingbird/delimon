# Issue #18: 進化機能の実装

### 背景 / 目的
レベル20・50到達時にキャラクターが進化するロジックを実装し、ユーザーに達成感を提供する。

- **依存**: #12
- **ラベル**: `backend`, `feature`

---

### スコープ / 作業項目

#### 1. 進化判定ロジックの実装
- `src/utils/evolution.ts` を作成
- `checkEvolution(level: number, evolutionStage: number): boolean` 関数を実装
- レベル20で1段階目→2段階目への進化判定
- レベル50で2段階目→3段階目への進化判定

#### 2. 進化処理の実装
- レベルアップ時に進化条件をチェック
- 進化条件を満たした場合、`character_type_id` を更新
- `evolution_stage` カラムも更新（1→2、2→3）

#### 3. character_types テーブルの参照
- character_typesテーブルから進化後のキャラクター情報を取得
- 進化系統に従って次のcharacter_type_idを取得
  - ハコブー（ID: 1）→ハコドン（ID: 2）→ハコキング（ID: 3）
  - ルートン（ID: 4）→ルードン（ID: 5）→ルーキング（ID: 6）
  - シールン（ID: 7）→シードン（ID: 8）→シーキング（ID: 9）

#### 4. 配送結果画面での進化条件表示
- 配送終了時に進化条件を満たした場合、「進化できます！」バッジを表示
- 「進化を見る」ボタンを表示（Phase 2の#19で実装）

#### 5. ホーム画面・図鑑での進化後反映
- 進化後のキャラクター画像がホーム画面で表示される
- 図鑑画面でも進化後のキャラクターが表示される

---

### ゴール / 完了条件（Acceptance Criteria）

- [ ] レベル20到達時に `character_type_id` を2段階目に更新できる（例: ハコブー→ハコドン）
- [ ] レベル50到達時に `character_type_id` を3段階目に更新できる
- [ ] 進化時に `evolution_stage` カラムも更新される
- [ ] 配送結果画面で進化条件を満たした場合に「進化できます！」を表示できる
- [ ] 進化後のキャラクター画像がホーム画面・図鑑で反映される

---

### テスト観点

#### 手動テスト
- レベル19→20の配送で進化条件を満たすことを確認
- 配送結果画面で「進化できます！」バッジが表示されることを確認
- Supabase Dashboardで `characters` テーブルの `character_type_id`, `evolution_stage` が更新されていることを確認
- ホーム画面で進化後のキャラクター画像が表示されることを確認
- 図鑑画面で進化後のキャラクターが表示されることを確認
- レベル49→50の配送で2段階目→3段階目への進化を確認

#### ユニットテスト（将来的）
```typescript
describe('checkEvolution', () => {
  it('レベル20、進化段階1で進化可能', () => {
    expect(checkEvolution(20, 1)).toBe(true);
  });
  it('レベル50、進化段階2で進化可能', () => {
    expect(checkEvolution(50, 2)).toBe(true);
  });
  it('レベル19、進化段階1で進化不可', () => {
    expect(checkEvolution(19, 1)).toBe(false);
  });
  it('レベル20、進化段階2で進化不可', () => {
    expect(checkEvolution(20, 2)).toBe(false);
  });
});
```

---

### 参考資料

- `docs/01_requirements_delimon.md` - 要件定義（進化システム）
- `docs/03_database_delimon.md` - データベース設計（character_typesテーブル）

---

### 要確認事項

- 進化レベル（20, 50）は適切か
- 進化後に自動で進化アニメーションを表示するか、ユーザーが「進化を見る」ボタンをタップするまで保留するか
- 進化条件を満たした後、複数回「進化を見る」ボタンを表示するか（1回のみか）
