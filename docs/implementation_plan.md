# デリモン - 実装計画書

**作成日**: 2025年11月6日
**バージョン**: 1.0
**ステータス**: 承認待ち

---

## フェーズ構成

**Phase 0: 環境構築・基盤**
目的: 開発に必要な基盤を整備し、以降の実装をスムーズにする
含むIssue: #1〜#4

**Phase 1: Walking Skeleton**
目的: 最小限のユーザー体験（配送→経験値獲得→レベルアップ）を実現し、価値検証可能な状態にする
含むIssue: #5〜#13

**Phase 2: コア機能の完成**
目的: MVP仕様に定義された全機能を実装し、リリース可能な状態にする
含むIssue: #14〜#22

**Phase 3: 堅牢化・UX向上**
目的: 本番運用に耐える品質とユーザー体験を実現する
含むIssue: #23〜#30

---

## 依存関係マップ

```
Phase 0:
#1 (Expoセットアップ) → #4 (状態管理・API基盤)
#2 (Supabaseセットアップ) → #3 (DBスキーマ) → #4

Phase 1:
#4 → #5 (ログイン), #6 (サインアップ), #9 (GPS前半)
#6 → #7 (キャラ選択) → #8 (ホーム)
#9 → #10 (GPS後半) → #11 (地図), #12 (経験値) → #13 (配送結果)

Phase 2:
#6 → #14 (プロフィール設定) → #15 (プロフィール編集)
#7 → #16 (チュートリアル)
#14 + #16 → #17 (スプラッシュ・画面遷移)
#12 → #18 (進化機能) → #19 (進化アニメ)
#8 → #20 (図鑑)
#10 → #21 (履歴前半) → #22 (履歴後半)

Phase 3:
#15 → #23 (設定メニュー) → #24 (ポリシー・規約), #25 (アカウント削除)
#13 → #26 (プッシュ通知)
全機能実装後 → #27 (エラーハンドリング), #28 (Sentry), #29 (最適化) → #30 (最終テスト)
```

---

## Issueアウトライン表

### Issue #1: Expoプロジェクトのセットアップ
**概要**: Expo SDK 52ベースのReact Nativeプロジェクトを初期化し、TypeScript・Expo Router・Lintツールを導入する
**依存**: -
**ラベル**: infra, setup
**受け入れ基準（AC）**:
- [ ] `npx create-expo-app`でプロジェクト作成完了
- [ ] TypeScript 5.3+の設定ファイル（tsconfig.json）が正しく配置されている
- [ ] Expo Router 4.0+が導入され、`app/`ディレクトリでルーティング可能
- [ ] ESLint・Prettierの設定ファイルが配置され、`npm run lint`が実行可能
- [ ] `npm start`でExpo Goアプリからアクセス可能
- [ ] .gitignoreに.env, node_modules等が含まれている

---

### Issue #2: Supabaseプロジェクトのセットアップ
**概要**: Supabase Dashboardでプロジェクトを作成し、クライアント接続設定を完了する
**依存**: -
**ラベル**: infra, backend
**受け入れ基準（AC）**:
- [ ] Supabase Dashboardでプロジェクト作成完了
- [ ] SUPABASE_URL、SUPABASE_ANON_KEYが取得され、`.env.example`に記載
- [ ] `@supabase/supabase-js`パッケージがインストール済み
- [ ] `src/services/supabase/client.ts`でSupabaseクライアント初期化完了
- [ ] 簡単なクエリ（例: `select 1`）で接続確認が取れる

---

### Issue #3: データベーススキーマの作成
**概要**: docs/03_database_delimon.mdに従い、全テーブル・RLSポリシー・トリガーを作成する
**依存**: #2
**ラベル**: backend, database
**受け入れ基準（AC）**:
- [ ] users, characters, character_types, delivery_sessionsテーブルがSupabase Dashboardで確認可能
- [ ] 各テーブルにRLSポリシーが設定され、auth.uid()で自分のデータのみアクセス可能
- [ ] character_typesに9体分のマスターデータが投入済み（ハコブー系3体、ルートン系3体、シールン系3体）
- [ ] usersテーブルのupdated_at自動更新トリガーが動作
- [ ] user_stats_view, public_user_profile_viewが作成され、データ取得可能

---

### Issue #4: 状態管理・API通信の基盤構築
**概要**: Zustand・TanStack Queryを導入し、認証・キャラクター・配送用のストア・カスタムフックの骨組みを作成する
**依存**: #1, #2
**ラベル**: frontend, infra
**受け入れ基準（AC）**:
- [ ] Zustand 5.0+、TanStack Query 5.59+がインストール済み
- [ ] `src/store/authStore.ts`, `characterStore.ts`, `deliveryStore.ts`, `profileStore.ts`が作成済み
- [ ] `src/lib/queryClient.ts`でTanStack Queryクライアント設定完了
- [ ] `src/services/supabase/auth.ts`にログイン・サインアップ関数の骨組み実装
- [ ] `src/hooks/useAuth.ts`で認証状態を取得できる

---

### Issue #5: ログイン画面の実装
**概要**: メールアドレス・パスワードでのログイン画面を実装し、Supabase Authと連携する
**依存**: #4
**ラベル**: frontend, auth
**受け入れ基準（AC）**:
- [ ] `app/(auth)/login.tsx`でログイン画面のUI作成完了
- [ ] メールアドレス・パスワードのバリデーション実装（リアルタイムエラー表示）
- [ ] 「ログイン」ボタンでSupabase Authのログイン実行、成功時にホーム画面へ遷移
- [ ] 認証エラー時に「メールアドレスまたはパスワードが間違っています」をダイアログ表示
- [ ] 「初めての方はこちら」リンクでキャラクター選択画面へ遷移

---

### Issue #6: サインアップ画面の実装
**概要**: 新規ユーザー登録画面を実装し、データ収集同意を取得してSupabase Authでアカウント作成する
**依存**: #4
**ラベル**: frontend, auth
**受け入れ基準（AC）**:
- [ ] `app/(auth)/signup.tsx`でサインアップ画面のUI作成完了
- [ ] パスワード要件チェック（8文字以上、英数字混在）をリアルタイムバリデーション
- [ ] データ収集同意チェックボックスがONでないと登録ボタンが無効
- [ ] サインアップ成功時にプロフィール設定画面へ遷移
- [ ] メールアドレス重複時に「このメールアドレスは既に使用されています」エラー表示

---

### Issue #7: キャラクター選択画面の実装
**概要**: 初回ユーザーが3種類から相棒キャラクターを選択する画面を実装する
**依存**: #6
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/(auth)/character-select.tsx`で3体のキャラクターカード表示
- [ ] 各カードにキャラクター画像・名前・説明を表示
- [ ] 「選ぶ」ボタンでキャラクター選択、charactersテーブルにINSERT
- [ ] 初回ユーザーはローカルストレージに選択保存→チュートリアル画面へ、ログイン済みはDB保存→プロフィール設定画面へ遷移
- [ ] 既にキャラクター所持時は「既にキャラクターを所持しています」エラー表示

---

### Issue #8: ホーム画面の基本実装
**概要**: タブナビゲーションを設定し、相棒キャラクターのレベル・経験値を表示するホーム画面を作成する
**依存**: #7
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/(tabs)/_layout.tsx`でタブナビゲーション（ホーム・配送・図鑑・履歴）設定完了
- [ ] `app/(tabs)/index.tsx`でキャラクター画像・名前・レベル・経験値バーを表示
- [ ] 経験値バーが現在の経験値/次のレベルまでの経験値を視覚的に表示
- [ ] 右上に設定ボタンを配置（タップ時は仮で何もしない）
- [ ] Pull-to-refreshでキャラクター情報を再取得

---

### Issue #9: GPS計測機能の基本実装（前半）
**概要**: expo-locationを導入し、位置情報の権限リクエスト・取得・配送開始/終了ボタンUIを実装する
**依存**: #4
**ラベル**: frontend, feature, gps
**受け入れ基準（AC）**:
- [ ] expo-location 18.0+がインストール済み
- [ ] `app/(tabs)/delivery.tsx`で配送画面の基本UI作成（配送開始/終了ボタン）
- [ ] 配送開始ボタンタップでGPS権限リクエスト、許可されたら位置情報取得開始
- [ ] GPS権限がない場合は「位置情報へのアクセスを許可してください」ダイアログ表示
- [ ] 配送中は「配送開始」ボタンが「配送終了」ボタンに変化

---

### Issue #10: GPS計測機能の基本実装（後半）
**概要**: リアルタイム距離計算・バックグラウンドトラッキング・配送セッションのDB保存を実装する
**依存**: #9
**ラベル**: frontend, backend, feature, gps
**受け入れ基準（AC）**:
- [ ] expo-task-manager 12.0+を導入し、バックグラウンドで位置情報取得可能
- [ ] 5秒間隔で位置情報を取得し、座標間の距離を計算して累積
- [ ] 配送終了時に走行距離・所要時間をdelivery_sessionsテーブルにINSERT
- [ ] バックグラウンド実行中に通知「配送中: 12.5km」を表示
- [ ] GPS信号が弱い場合に警告メッセージを表示

---

### Issue #11: 地図表示機能の実装
**概要**: react-native-mapsを導入し、配送画面に地図・現在地マーカー・移動軌跡を表示する
**依存**: #9
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] react-native-maps 1.18+がインストール済み
- [ ] `app/(tabs)/delivery.tsx`で地図を全画面表示
- [ ] 現在地に青いマーカーを表示
- [ ] 配送中は移動軌跡を青いラインで地図上に描画
- [ ] スタート地点に緑のマーカーを表示

---

### Issue #12: 経験値・レベルシステムの実装
**概要**: 配送終了時に距離から経験値を計算し、レベルアップ判定・キャラクター情報更新を実装する
**依存**: #10
**ラベル**: backend, feature
**受け入れ基準（AC）**:
- [ ] `src/utils/calculate.ts`に経験値計算関数（1km=100経験値）を実装
- [ ] レベルアップ判定ロジック（1レベル=1,000経験値）を実装
- [ ] 配送終了時にキャラクターの経験値・レベルをUPDATE
- [ ] レベルアップ時にホーム画面で光のエフェクト表示
- [ ] レベルアップ回数が複数回の場合も正しく処理

---

### Issue #13: 配送結果画面の実装
**概要**: 配送終了後に走行距離・獲得経験値・レベルアップを表示するモーダル画面を作成する
**依存**: #12
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/delivery-result.tsx`でモーダル形式の配送結果画面を作成
- [ ] 走行距離・所要時間・平均速度・獲得経験値を表示
- [ ] レベルアップした場合は「Lv.5 → Lv.7」のように変化を表示
- [ ] 進化条件を満たした場合は「進化できます！」バッジと「進化を見る」ボタンを表示
- [ ] 「ホームへ戻る」ボタンでホーム画面へ遷移

---

### Issue #14: プロフィール設定画面の実装
**概要**: 初回登録時にニックネーム・生年月日・性別・業種を入力するプロフィール設定画面を実装する
**依存**: #6
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/(auth)/profile-setup.tsx`でプロフィール設定画面のUI作成
- [ ] ニックネーム（2〜20文字、特殊文字禁止）、生年月日、性別、業種の入力フォーム実装
- [ ] リアルタイムバリデーションでエラーをフィールド下に表示
- [ ] 完了ボタンで4桁識別番号（0001〜9999）を自動生成し、usersテーブルをUPDATE
- [ ] 保存成功後にホーム画面へ遷移

---

### Issue #15: プロフィール編集画面の実装
**概要**: 設定メニューからプロフィール情報を編集できる画面を実装する
**依存**: #14
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/settings/profile-edit.tsx`でプロフィール編集画面のUI作成
- [ ] 既存プロフィール情報を表示（識別番号は表示のみで編集不可）
- [ ] 入力内容に変更がある場合のみ保存ボタンを有効化
- [ ] 変更ありで戻るボタンタップ時に「変更を破棄しますか？」確認ダイアログ表示
- [ ] 保存成功後に「保存しました」メッセージ表示→設定メニューへ戻る

---

### Issue #16: チュートリアル画面の実装
**概要**: 初回起動時の4画面スライド形式のチュートリアルを実装する
**依存**: #7
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/tutorial.tsx`で4画面のスライド実装（スワイプで切り替え）
- [ ] 各画面にキャラクター画像・説明文を表示
- [ ] インジケーター（●●○○）で現在位置を表示
- [ ] 4画面目に「アカウント登録」ボタンを配置、タップでサインアップ画面へ遷移
- [ ] スキップ不可（必ず4画面見る仕様）

---

### Issue #17: スプラッシュ画面・画面遷移ロジックの実装
**概要**: アプリ起動時にセッション確認・プロフィール設定済みチェックを行い、適切な画面へ遷移する
**依存**: #14, #16
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/_layout.tsx`または`app/index.tsx`でスプラッシュ画面を表示（1〜3秒）
- [ ] Supabase Authのセッション確認を実施
- [ ] ログイン済み＆プロフィール設定済み→ホーム画面、ログイン済み＆プロフィール未設定→プロフィール設定画面へ遷移
- [ ] ログアウト＆既存ユーザー→ログイン画面、ログアウト＆初回ユーザー→キャラクター選択画面へ遷移
- [ ] 遷移判定が1秒以内に完了

---

### Issue #18: 進化機能の実装
**概要**: レベル20・50到達時にキャラクターが進化するロジックを実装する
**依存**: #12
**ラベル**: backend, feature
**受け入れ基準（AC）**:
- [ ] レベル20到達時にcharacter_type_idを2段階目に更新（例: ハコブー→ハコドン）
- [ ] レベル50到達時にcharacter_type_idを3段階目に更新
- [ ] 進化時にevolution_stageカラムも更新
- [ ] 配送結果画面で進化条件を満たした場合に「進化できます！」を表示
- [ ] 進化後のキャラクター画像がホーム画面・図鑑で反映される

---

### Issue #19: 進化アニメーション画面の実装
**概要**: 進化時の演出画面を実装し、進化前→光エフェクト→進化後の流れを表示する
**依存**: #18
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/evolution.tsx`でフルスクリーンの進化アニメーション画面を作成
- [ ] Phase 1（1秒）: 進化前キャラクター表示
- [ ] Phase 2（2秒）: シルエット化＋光エフェクト（キラキラ）
- [ ] Phase 3（3秒）: 進化後キャラクター表示＋「おめでとう！」メッセージ
- [ ] 「OK」ボタンでホーム画面へ遷移（スキップ不可）

---

### Issue #20: 図鑑画面の実装
**概要**: 相棒キャラクターをカラー表示し、その他8体をシルエット表示する図鑑画面を実装する
**依存**: #8
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/(tabs)/collection.tsx`で図鑑画面のUI作成
- [ ] 3列グリッドで9体のキャラクターを表示
- [ ] 相棒キャラクターはカラー表示＋「相棒」バッジ＋レベル表示
- [ ] 未取得キャラクターはシルエット＋「???」＋「未取得」表示
- [ ] 収集率「1 / 9体」を上部に表示

---

### Issue #21: 履歴画面の実装（前半）
**概要**: 配送履歴の一覧表示と期間別フィルタリングを実装する
**依存**: #10
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/(tabs)/history.tsx`で履歴画面のUI作成
- [ ] 期間選択タブ（今週・今月・全期間）を実装
- [ ] 配送履歴をリスト表示（日時・距離・所要時間・獲得経験値）
- [ ] 進化した配送には進化アイコンを表示
- [ ] Pull-to-refreshでデータ再取得

---

### Issue #22: 履歴画面の実装（後半）
**概要**: 期間別の統計カードと走行距離グラフを実装する
**依存**: #21
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] react-native-chart-kit 6.12+がインストール済み
- [ ] 期間別統計カード（合計走行距離・配送回数・獲得経験値）を上部に表示
- [ ] 走行距離グラフを棒グラフで表示（横軸: 日付、縦軸: 距離）
- [ ] 期間タブ切り替えでグラフと統計が更新される
- [ ] グラフがスムーズにレンダリング（500ms以内）

---

### Issue #23: 設定メニュー画面の実装
**概要**: 各種設定へのアクセスポイントとなる設定メニュー画面を実装する
**依存**: #15
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/settings/index.tsx`で設定メニュー画面のUI作成
- [ ] ユーザー情報（ニックネーム#識別番号、メールアドレス、登録日）を上部に表示
- [ ] プロフィール編集、通知設定、地図設定、データ収集設定のメニュー項目を配置
- [ ] プライバシーポリシー、利用規約、アカウント削除、ログアウトのメニュー項目を配置
- [ ] 各項目タップで対応する画面へ遷移、またはトグル切り替え

---

### Issue #24: プライバシーポリシー・利用規約画面の実装
**概要**: プライバシーポリシーと利用規約の表示画面を実装する
**依存**: #23
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] `app/settings/privacy.tsx`でプライバシーポリシー画面を作成
- [ ] `app/settings/terms.tsx`で利用規約画面を作成
- [ ] スクロール可能なテキストで全文を表示
- [ ] 戻るボタンで設定メニューへ戻る
- [ ] プライバシーポリシーにプロフィール情報の収集・利用・公開範囲を明記

---

### Issue #25: アカウント削除機能の実装
**概要**: ユーザーが自分のアカウントとすべてのデータを削除できる機能を実装する
**依存**: #23
**ラベル**: frontend, backend, feature
**受け入れ基準（AC）**:
- [ ] `app/settings/delete-account.tsx`でアカウント削除確認画面を作成
- [ ] 削除されるデータのリスト（キャラクター・配送履歴・プロフィール等）を表示
- [ ] 「上記の内容を理解しました」チェックボックスがONで削除ボタン有効化
- [ ] 削除ボタンタップで最終確認ダイアログ表示、確認後にSupabaseからユーザー削除（CASCADE DELETEで関連データも削除）
- [ ] 削除完了後にローカルストレージクリア→ログイン画面へ遷移

---

### Issue #26: プッシュ通知機能の実装
**概要**: レベルアップ・進化可能時にプッシュ通知を送信する機能を実装する
**依存**: #13
**ラベル**: frontend, feature
**受け入れ基準（AC）**:
- [ ] expo-notifications 0.29+がインストール済み
- [ ] FCM（Firebase Cloud Messaging）との連携設定完了
- [ ] レベルアップ時に「おめでとう！レベル5になりました！」通知送信
- [ ] レベル20・50到達時に「ハコブーが進化できます！」通知送信
- [ ] 設定メニューで通知のON/OFF切り替え可能

---

### Issue #27: エラーハンドリング・ローディング状態の強化
**概要**: 全画面で一貫したエラーハンドリングとローディング表示を実装する
**依存**: 全機能実装後（#1〜#26）
**ラベル**: frontend, infra
**受け入れ基準（AC）**:
- [ ] TanStack Queryのエラーハンドリングを統一（3回リトライ、指数バックオフ）
- [ ] ネットワークエラー時に「ネットワークに接続できません」ダイアログ表示＋リトライボタン
- [ ] 全API呼び出しでローディングインジケーター表示
- [ ] GPS権限エラー時に設定画面への誘導ダイアログ表示
- [ ] ErrorBoundaryで予期しないエラーをキャッチし、エラー画面表示

---

### Issue #28: Sentryの導入・エラー監視
**概要**: Sentryを導入し、本番環境でのエラーを自動収集・監視できるようにする
**依存**: 全機能実装後（#1〜#26）
**ラベル**: infra, monitoring
**受け入れ基準（AC）**:
- [ ] Sentry 5.33+がインストール済み
- [ ] `src/lib/sentry.ts`でSentry初期化（DSN設定、environment設定）
- [ ] JavaScriptエラー、ネットワークエラー、アプリクラッシュを自動送信
- [ ] beforeSend関数で個人情報（メールアドレス等）を除外
- [ ] Sentryダッシュボードでエラーが確認可能

---

### Issue #29: パフォーマンス最適化
**概要**: アプリ全体のパフォーマンスを測定し、画面遷移・レンダリング・キャッシュを最適化する
**依存**: 全機能実装後（#1〜#26）
**ラベル**: frontend, perf
**受け入れ基準（AC）**:
- [ ] 画面遷移が500ms以内（ホーム→配送、ホーム→図鑑等）
- [ ] TanStack Queryのキャッシュ設定を最適化（docs/02_architecture_delimon.mdのキャッシュ戦略に準拠）
- [ ] 履歴画面のリストをFlatListで仮想化し、スムーズにスクロール
- [ ] 不要な再レンダリングをReact.memo, useMemo, useCallbackで削減
- [ ] キャラクター画像を適切なサイズに圧縮（各画像100KB以下）

---

### Issue #30: 最終テスト・バグ修正
**概要**: 実機での総合テストを実施し、発見されたバグを修正してMVPを完成させる
**依存**: 全Issue完了後（#1〜#29）
**ラベル**: test, bugfix
**受け入れ基準（AC）**:
- [ ] Android・iOS実機でGPS計測の精度確認（実際に移動してテスト）
- [ ] バックグラウンド実行時のバッテリー消費確認（1時間で5%以内）
- [ ] 全画面遷移フローの確認（初回ユーザー、既存ユーザー、各種エラーケース）
- [ ] 発見されたバグをすべて修正
- [ ] docs/配下の設計書との整合性確認（仕様漏れがないか）
- [ ] ストア申請用のスクリーンショット・説明文を準備

---

## 要確認事項

1. **Google Maps APIキーの取得手順**: 誰が取得するか、費用負担の確認
2. **Sentryの無料枠で十分か**: 月5,000エラーで足りるか、有料プラン検討の要否
3. **キャラクター画像の作成**: 9体分の画像を誰が作成するか（デザイナー手配の要否）
4. **プライバシーポリシー・利用規約の文面**: 法務チェックの要否
5. **EAS Buildの実行**: 誰がビルドを実行するか、Apple Developer Accountの準備状況
6. **Issue #10（バックグラウンドGPS）の難易度**: 想定より時間がかかる可能性あり、分割検討
7. **Issue #29（パフォーマンス最適化）の優先度**: MVPリリース前に必須か、リリース後でも可か

---

## 補足情報

### 見積もり時間
- Phase 0: 約3日
- Phase 1: 約2週間
- Phase 2: 約2週間
- Phase 3: 約1.5週間
- **合計**: 約6〜7週間（設計書の8.5週間から短縮）

### 並行作業の可能性
- Issue #5, #6 は並行作業可能
- Issue #9, #11 は並行作業可能
- Issue #14, #16 は並行作業可能
- Issue #20, #21 は並行作業可能

### リスク高いIssue
- **Issue #10**: バックグラウンドGPS、expo-task-managerの習熟が必要
- **Issue #18, #19**: 進化ロジック・アニメーション、仕様の細部確認が必要
- **Issue #26**: プッシュ通知、FCMの設定が複雑

---

以上
